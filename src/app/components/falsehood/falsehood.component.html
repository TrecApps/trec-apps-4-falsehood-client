<app-top-bar (dataEmitter)="prepData()"></app-top-bar>
<div class="container" *ngIf="falsehoodService.currentFalsehood">

    <nav class="rs-nav-bar navbar navbar-expand-lg">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#factcheckNavCollapse" aria-controls="factcheckNavCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <!-- Common Across the entire app -->
        <div class="collapse navbar-collapse" id="factcheckNavCollapse">
            <ul class="navbar-nav">
                <li class="nav-item"><p class="nav-link" (click)="setMode(META)">Details</p></li>
                <li class="nav-item"><p class="nav-link" (click)="setMode(CONTENT)">Content</p></li>
                <li class="nav-item"><p class="nav-link" (click)="setMode(META)">Briefs</p></li>
            </ul>
        </div>
    </nav>

    <form *ngIf="mode == META" class="form element-container" [ngClass]="'element-container-' + styleService.style">
        <div class="form-group">
            <label class="form-label">Status: {{ falsehoodService.currentFalsehood.fullMetaData?.status }}</label>
            <button class="btn btn-primary" *ngIf="canReview() && !isReviewing" (click)="prepReview()">Review</button>
            
            <button class="btn btn-primary" *ngIf="canAppeal() && !isAppealing" (click)="isAppealing = true">Appeal</button>
        </div>

        <div class="form-group" *ngIf="falsehoodService.currentFalsehood.fullMetaData">
            <label class="form-label">Title</label>
            <p *ngIf="!canSubEdit() && !canEmpEdit()">{{ falsehoodService.currentFalsehood.fullMetaData.title }}</p>
            <input 
                *ngIf="canSubEdit() || canEmpEdit()" 
                class="form-control" 
                [(ngModel)]="falsehoodService.currentFalsehood.fullMetaData.title"
                (ngModelChange)="titleChanged = true"
            >
            <button class="btn btn-primary" *ngIf="titleChanged && falsehoodService.currentFalsehood.fullMetaData.title.trim().length" (click)="onUpdateTitle()"
                [disabled]="titleUpdating">Update Title</button>
        </div>

        <div class="form-group">

            <label>Public Figure</label>
            <p>{{ falsehoodService.currentFalsehood.fullMetaData?.publicFigure?.name || 'N.A.' }}</p>
            <div *ngIf="canSubEdit() || canEmpEdit()">
                <button class="btn btn-primary" (click)="editingPF = true" *ngIf="!editingPF">Edit Public Figure</button>
                <button class="btn btn-danger" (click)="editingPF = false" *ngIf="editingPF">Edit Public Figure</button>
                <app-brand-searcher *ngIf="editingPF" (brandInfoSelected)="publicFigure = $event"></app-brand-searcher>
                <button class="btn btn-light" *ngIf="changedPf()" (click)="updatePublicFigure()">Update Public Figure</button>
            </div>

        </div>
        <div class="form-group">

            <label>Media Outlet</label>
            <p>{{ falsehoodService.currentFalsehood.fullMetaData?.mediaOutlet?.name || 'N.A.' }}</p>
            <div *ngIf="canSubEdit() || canEmpEdit()">
                <button class="btn btn-primary" (click)="editingMO = true" *ngIf="!editingMO">Edit Media Outlet</button>
                <button class="btn btn-danger" (click)="editingMO = false" *ngIf="editingMO">Edit Media Outlet</button>
                <app-brand-searcher *ngIf="editingMO" (brandInfoSelected)="mediaOutlet = $event"></app-brand-searcher>
                <button class="btn btn-light" *ngIf="changedMo()" (click)="updateMediaOutlet()">Update Media Outlet</button>
            </div>

        </div>
        <div class="form-group">

            <label>Institution</label>
            <p>{{ falsehoodService.currentFalsehood.fullMetaData?.institution?.name || 'N.A.' }}</p>
            <div *ngIf="canSubEdit() || canEmpEdit()">
                <button class="btn btn-primary" (click)="editingIN = true" *ngIf="!editingIN">Edit Institution</button>
                <button class="btn btn-danger" (click)="editingIN = false" *ngIf="editingIN">Edit Institution</button>
                <app-brand-searcher *ngIf="editingIN" (brandInfoSelected)="institution = $event"></app-brand-searcher>
                <button class="btn btn-light" *ngIf="changedIn()" (click)="updateInstitution()">Update Institution</button>
            </div>

        </div>
        <div class="form-group">
            <label>Date Made</label>
            <p>{{ falsehoodService.currentFalsehood.fullMetaData?.dateMade }}</p>
            <div *ngIf="canSubEdit()">
                <button class="btn btn-primary" (click)="editingDate = true" *ngIf="!editingDate">Edit Date</button>
                <button class="btn btn-danger" (click)="editingDate = false" *ngIf="editingDate">Edit Date</button>
                <input class="form-check-button" *ngIf="editingDate" [(ngModel)]="useDate">
                <label class="form-check-label">Use Date</label>
                <input type="date" *ngIf="editingDate && useDate" [(ngModel)]="date">
                <button class="btn btn-light" *ngIf="changedIn()" (click)="updateInstitution()">Update Institution</button>
            </div>
        </div>

        <div class="form-group">
            <label>Severity</label>
            <p>{{ falsehoodService.currentFalsehood.fullMetaData?.severity }}</p>
            
            <div *ngIf="canSubEdit() || canEmpEdit()">
                <button class="btn btn-primary" (click)="editingSeverity = true" *ngIf="!editingSeverity">Edit Severity</button>
                <button class="btn btn-danger" (click)="editingSeverity = false" *ngIf="editingSeverity">Edit Severity</button>
                <select class="form-select" [(ngModel)]="severity">
                    <option [value]="severityObjective">Objective</option>
                    <option [value]="severityOppWithheld">Opposing Evidence Withheld</option>
                    <option [value]="severitySuppWithheld">Supporting Evidence Withheld</option>
                    <option [value]="severitySubjective">Double Stadard</option>
                    <option [value]="severityLogic">Faulty Logic</option>
                    <option [value]="severityNarrative">Misleading Narrative</option>
                    <option [value]="severitySlogan">Misleading Title/Slogan</option>
                </select>
                <button class="btn btn-light" *ngIf="falsehoodService.currentFalsehood.fullMetaData?.severity !== severity" (click)="updateInstitution()">Update Institution</button>
            </div>
        </div>

        <div class="form-group">
            <label>Tags</label>
            <p><span *ngFor="let tag of falsehoodService.currentFalsehood.fullMetaData?.tags"> {{tag }}</span></p>
            
            <div *ngIf="canSubEdit()">
                <button class="btn btn-primary" (click)="editingTags = true" *ngIf="!editingTags">Edit Tags</button>
                <button class="btn btn-danger" (click)="editingTags = false" *ngIf="editingTags">Edit Tags</button>
                <lib-tag-input  #tagComp [tags]="falsehoodService.currentFalsehood.fullMetaData?.tags || []"></lib-tag-input>
                <p class="text-danger" *ngIf="cantUpdateTags.length">Each tag must be found within the contents of the Falsehood. {{cantUpdateTags}} was not found</p>
                <button class="btn btn-light" (click)="updateTags()">Update Tags</button>
            </div>
        </div>

        <div *ngfor="let record of falsehoodService.currentFalsehood.fullMetaData.records" class="element-item" [ngClass]="'element-item-' + styleService.style">
            <p><b>By: </b>{{ record.displayName }}</p>
            <p><b>Made: </b>{{ record.date }}</p>
            <p><b>Event: </b>{{ record.event }}</p>
            <p><b>Notes: </b>{{ record.comment }}</p>
        </div>
    </form>

    <form *ngIf="mode == CONTENT" class="form element-container" [ngClass]="'element-container-' + styleService.style">
        <h3>Explaination</h3>
        <div *ngIf="canSubEdit()">
            <button class="btn btn-primary" (click)="editingContent = true" *ngIf="!editingContent">Edit Tags</button>
            <button class="btn btn-danger" (click)="editingContent = false" *ngIf="editingContent">Edit Tags</button>

            <lib-markdown-editor #fcMdEditor *ngIf="editingContent" [content]="getContent()"></lib-markdown-editor>
            <p class="text-danger" *ngIf="cantUpdateTags.length">Each tag must be found within the contents of the Falsehood. {{cantUpdateTags}} was not found</p>
            <button class="btn btn-light" *ngIf="editingContent" (click)="updateContent()">Update Tags</button>
        </div>
        <div *ngIf="!editingContent" class="md-preview-side" [innerHtml]="getContent() | markdown"></div>
    </form>

    <form *ngIf="mode == BRIEFS">

        <button class="btn btn-primary" *ngIf="canAddbrief() && !addingBrief && isAccepted()" (click)="addingBrief = true">Submit Brief</button>
        <div *ngIf="addingBrief">
            <select class="form-select" [(ngModel)]="purpose">
                <option [value]="purposeAffirm">Affirm (you support Confirmation)</option>
                <option [value]="purposeOppose">Oppose (you oppose Confirmation)</option>
                <option [value]="purposeSuggest">Suggest</option>
            </select>

            <lib-markdown-editor #briefEditor [content]="getContent()"></lib-markdown-editor>
            <button class="btn btn-danger" (click)="addingBrief = false">Cancel</button>
            <button class="btn btn-primary" (click)="submitBrief()">Submit</button>
        </div>

        <hr>

        <app-brief *ngFor="let brief of falsehoodService.currentFalsehood.briefs" [brief]="brief" [falsehoodId]="falsehoodService.currentFalsehood.fullMetaData?.id || 'null'"></app-brief>
    </form>
</div>

<lib-up-slider (onClose)="isReviewing = false" [isActive]="(falsehoodService.currentFalsehood !== undefined) && isReviewing">
    <form class="form">
        <div class="form-group">
            <div *ngFor="let act of reviewOptions" class="form-check">
                <input class="form-check-input" type="radio" [value]="act" [(ngModel)]="reviewOption" name="actionSelection" [id]="'actSelect'+ act">
                <label class="form-check-label" [for]="'actSelect'+ act">
                  {{act}}
                </label>
            </div>
        </div>
        <div class="form-group">
            <label>Comment</label>
            <textarea [(ngModel)]="reviewComent" class="form-control"></textarea>
        </div>
        <div class="form-group" *ngIf="'deny' == reviewOption">
            <label>Deduct Points</label>
            <input [(ngModel)]="reviewPoints" type="number" min="0" max="50">
        </div>
        <button class="btn btn-primary" (click)="submitReview()" *ngIf="reviewOption.length > 0 && reviewComent.trim().length > 0">Post Review</button>
        <button class="btn btn-danger" (click)="isReviewing = false">Cancel</button>
    </form>
</lib-up-slider>

<!-- <div *ngIf="falsehoodService.currentFalsehood && isReviewing" class="review-panel">
    
</div> -->

<lib-up-slider (onClose)="isAppealing = false" [isActive]="(falsehoodService.currentFalsehood !== undefined) && isAppealing">
    <form class="form">
        <div class="form-group">
            <label>Comment</label>
            <textarea [(ngModel)]="appealComment" class="form-control"></textarea>
        </div>

        <button class="btn btn-primary" (click)="submitAppeal()" *ngIf="appealComment.trim().length > 0">Post Appeal</button>
        <button class="btn btn-danger" (click)="isAppealing = false">Cancel</button>
    </form>
</lib-up-slider>

<!-- <div *ngIf="falsehoodService.currentFalsehood && isAppealing" class="review-panel">

</div> -->

<div *ngIf="!falsehoodService.currentFalsehood">
    <!--ToDo: handle situation-->
</div>
